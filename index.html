<!DOCTYPE html>
<html>

<head>
    <title>Tiles</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
        crossorigin="" />

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
        crossorigin=""></script>
    <link rel="stylesheet" href="leaflet-sidebar.css" />
    <script src="leaflet-sidebar.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/rivets/0.9.6/rivets.bundled.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.1.0/leaflet.polylineDecorator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-contextmenu/1.4.0/leaflet.contextmenu.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-contextmenu/1.4.0/leaflet.contextmenu.css" />

    <script>
        /// <reference path="../../../../../node_modules/@types/leaflet/index.d.ts" />
        var layer;
        function init() {

            var defaultConfig = { //Much of this should move into a settings area eventually.
                PathColorPriority: [ //Pulled from the 100% NMG guide, arbitrary?
                    "#ffff00",
                    "#01fc01",
                    "#ff8000",
                    "#008000",
                    "#00ffff"
                ],
                Controls: { //Currently using "keypress" vs "keydown" due to lack of "keydown" support in leaflet
                    CancelPath: 120, //x
                    RemoveLastPathPart: 99, //c
                    SavePathPart: 13, //enter
                    NewSegment: 115, //s
                    DraggingToggle: 100 //d
                },
                DefaultNewSegmentFormat: "Segment: {0}",
                DefaultNewPathFormat: "Step: {0}"
            };

            var defaultData = {
                routes: [
                    {
                        name: "Route: 100% NMG",
                        segments: [
                            {
                                name: "Segment: 1",
                                notes: "",
                                paths: [

                                ]
                            }

                        ]
                    },
                    {
                        name: "Route: Any% NMG",
                        segments: []
                    }
                ]
            };

            // Initialize Variables
            var currentColorIndex = -1;
            var currentRoute;
            var currentLine;
            var currentSegment = 0;
            var points = [];
            var isEditingRoute = false;
            var data;
            var config;
            var selectedLine;


            load();

            //Initialize Map
            var mapMinZoom = 0;
            var mapMaxZoom = 5;
            var map = L.map('map', {
                maxZoom: mapMaxZoom,
                minZoom: mapMinZoom,
                crs: L.CRS.Simple,
                boxZoom: false,
                contextmenu: true,


            }).setView([0, 0], mapMaxZoom);

            map.on('contextmenu.show', function (event) {
                if (event.relatedTarget != undefined)
                    selectedLine = event.relatedTarget;
            });

            var legend = L.control({ position: 'bottomright' });

            legend.onAdd = function (map) {
                return L.DomUtil.get('legend');
            };

            legend.addTo(map);


            var customLine = L.Polyline.extend({
                options: {
                    routeIndex: undefined,
                    segment: undefined,
                    decorator: undefined
                }
            });


            var mapBounds = new L.LatLngBounds(
                map.unproject([0, 3072], mapMaxZoom),
                map.unproject([4608, 0], mapMaxZoom));

            map.fitBounds(mapBounds);
            layer = L.tileLayer('{z}/{x}/{y}.png', {
                minZoom: mapMinZoom, maxZoom: mapMaxZoom,
                bounds: mapBounds,
                attribution: 'Rendered with <a href="https://www.maptiler.com/">MapTiler</a>',
                noWrap: true,
                tms: false,
                className: "Main"
            }).addTo(map);

            var pathLayer = L.layerGroup().addTo(map);

            function onMapKeypress(e) {
                if (isEditingRoute) {
                    switch (e.originalEvent.keyCode) {
                        case config.Controls.SavePathPart:

                            addArrow(currentLine);

                            if (currentRoute.segments == undefined || currentRoute.segments.length == 0) {
                                currentSegment = -1;
                                addSegment();
                            }

                            if (currentRoute.segments[currentSegment].paths == undefined)
                                currentRoute.segments[currentSegment].paths = [];

                            currentRoute.segments[currentSegment].paths.push(
                                {
                                    name: config.DefaultNewPathFormat.replace("{0}", currentRoute.segments[currentSegment].paths.length + 1),
                                    points: points,
                                    notes: ""
                                }
                            );
                            currentLine.options.segment = currentRoute.segments[currentSegment];
                            addContextMenu(currentLine);
                            currentLine = undefined;
                            points = [];
                            break;
                        case config.Controls.RemoveLastPathPart:
                            points.pop();
                            currentLine.setLatLngs(points);
                            break;
                        case config.Controls.CancelPath:
                            points = [];
                            currentLine.removeFrom(map);
                            currentColorIndex--;
                            currentLine = undefined;
                            break;
                        case config.Controls.NewSegment:
                            addSegment();
                            break;
                        case config.Controls.DraggingToggle:
                            if (map.dragging._enabled)
                                map.dragging.disable();
                            else
                                map.dragging.enable();
                            break;
                    }
                }
            }

            function addRoute(model) {
                
                var route = {
                    name: "New Route",
                    segments: [
                        {
                            name: config.DefaultNewSegmentFormat.replace("{0}", currentSegment + 1),
                            notes: "",
                            paths: [

                            ]
                        }
                    ]
                };
                
                model.data.routes.push(route);

            }

            function addSegment() {

                currentLine = undefined;
                currentColorIndex = -1;
                currentSegment++;
                points = [];
                if (currentRoute.segments == undefined)
                    currentRoute.segments = [];

                if (currentRoute.segments == 0)
                    currentColorIndex = 0;

                currentRoute.segments.push({
                    name: config.DefaultNewSegmentFormat.replace("{0}", currentSegment + 1),
                    notes: "",
                    paths: [

                    ]
                });
            }

            var sidebar = L.control.sidebar('sidebar').addTo(map);

            rivets.binders.routes = {

                bind: function (el) {
                    var opts = {};
                    opts.onSet = this.publish;
                },

                unbind: function (el) {

                },

                routine: function (el, value) {
                },

                getValue: function (el) {

                }
            };

            var routeController = {
                enabled: false,
                headerClick: function (event, rivetData) {
                    if (event.target.tagName == "I")
                        return;

                    rivetData.route.enabled = !rivetData.route.enabled;
                    openRoute(rivetData);

                },
                edit: function (event, rivetData) {

                    rivetData.route.enabled = true;
                    openRoute(rivetData);

                    if (rivetData.route.isEditingRoute) {
                        rivetData.route.isEditingRoute = false;
                        map.off('click', addPathSegment);
                        map.off('keypress', onMapKeypress);
                        map.dragging.enable();
                        isEditingRoute = false;
                    } else {
                        currentRoute = rivetData.route;
                        currentSegment = 0;
                        isEditingRoute = true;
                        currentRoute.isEditingRoute = isEditingRoute;
                        map.dragging.disable();
                        map.on('click', addPathSegment);
                        map.on('keypress', onMapKeypress);
                    }
                },
                addNewRoute: function (event, rivetData) {
                    addRoute(rivetData);
                }
            };

            function openRoute(rivetData) {
                pathLayer.clearLayers();

                if (rivetData.route.enabled) {
                    currentRoute = rivetData.route;
                    currentSegment = 0;

                    closeRoutes(rivetData);
                    loadRoute(rivetData.route);
                }
            }

            function closeRoutes(rivetData) {
                $.each(rivetData.data.routes, function (i, e) {
                    if (e != rivetData.route && (e.enabled || e.isEditingRoute)) {
                        e.enabled = false;
                        e.isEditingRoute = false;
                        map.off('click', addPathSegment);
                        map.off('keypress', onMapKeypress);
                        map.dragging.enable();
                        isEditingRoute = false;
                    }
                });
            }


            function loadRoute(route) {
                $.each(route.segments, function (i, e) {
                    currentColorIndex = -1;
                    loadSegment(e);
                })
            }

            function loadSegment(segment) {
                $.each(segment.paths, function (i, e) {
                    var line = new customLine(e.points, {
                        color: getNextColor(),
                        weight: 3,
                        opacity: 1,
                        smoothfactor: 1,
                        routeIndex: i,
                        segment: segment
                    }).addTo(pathLayer);

                    addContextMenu(line);

                    addArrow(line);
                });
            }

            function addContextMenu(line) {
                line.bindContextMenu({
                    contextmenu: true,
                    contextmenuWidth: 140,
                    contextmenuItems: [{
                        text: 'Delete Step',
                        callback: deletePath,
                        context: line
                    }]
                })
            }

            function deletePath() {
                selectedLine.options.segment.paths.splice(selectedLine.options.routeIndex, 1);
                selectedLine.options.decorator.remove();
                pathLayer.removeLayer(selectedLine);

            }

            function addArrow(line) {
                var decorator = L.polylineDecorator(line, {
                    patterns: [
                        // defines a pattern of 10px-wide dashes, repeated every 20px on the line
                        { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 8, polygon: false, pathOptions: { stroke: true, color: config.PathColorPriority[currentColorIndex], } }) }
                    ]
                }).addTo(pathLayer);
                line.options.decorator = decorator;
            }

            function addPathSegment(e) {
                points.push(e.latlng);
                if (currentLine == undefined) {
                    if (points.length > 1) {
                        currentLine = new L.polyline(points, {
                            color: getNextColor(),
                            weight: 3,
                            opacity: 1,
                            smoothfactor: 1
                        }).addTo(pathLayer);

                    }
                } else {
                    currentLine.addLatLng(e.latlng);
                }
            }

            var view = rivets.bind($('#routes'), { data: data, controller: routeController });
            var legend = rivets.bind($('#legend'), { config: config, isEditingRoute: true, showLegend: true, fromCharCode: function(e) {
                if (e == 13) 
                    return "Enter";

                return String.fromCharCode(e);
            } });

            function getNextColor() {
                if (currentColorIndex >= config.PathColorPriority.length - 1) {
                    currentColorIndex = 0;
                } else {
                    currentColorIndex++;
                }

                return config.PathColorPriority[currentColorIndex];

            }

            //Using local storage for now. If this thing takes off will probably need to switch this to server storage
            function save() {
                localStorage.setItem("srpData", JSON.stringify(data));
                localStorage.setItem("srpConfig", JSON.stringify(config));
            }

            function load() {
                data = JSON.parse(localStorage.getItem("srpData"));
                config = JSON.parse(localStorage.getItem("srpConfig"));
                if (data == undefined) {
                    data = defaultData;
                    config = defaultConfig;
                }
                $.each(data.routes, function (i, e) {
                    e.enabled = false;
                });
            }

            $("#btnSave").on('click', function () {
                save();
            });

        }
    </script>
    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            z-index: 1;
        }

        #slider {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
        }

        .leaflet-container {
            background: #000000;
        }


        #routes ul>li span.header {
            font: normal normal normal 14px/1 FontAwesome;
            font-size: inherit;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            background-color: #180d56;
            color: #FFFFFF;
            border-radius: 4px;
            padding: 5px;
            margin: 5px 0 5px -40px;
            cursor: pointer;
            width: 100%;
            display: inline-block
        }

        #routes ul>li span.header i.editactive {
            color: #FF0000;
        }

        #routes ul>li span.header i {
            float: right;
            color: #888888
        }

        #routes ul {
            list-style-type: none;
        }
        /*
        #routes {
            
        }
*/

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .legend {
            line-height: 18px;
            color: #555;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        #addNewRoute {
            color: #180d56;
            margin: 5px 5px 0px 5px;
            cursor: pointer;
        }
    </style>
</head>

<body onload="init()">
    <div id="sidebar" class="sidebar ">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li class="active"><a href="#home" role="tab"><i class="fa fa-map"></i></a></li>
                <li><a href="#layers" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#help" role="tab"><i class="fa fa-question-circle"></i></a></li>
            </ul>

            <ul role="tablist">
                <li id="btnSave"><a href="javascript:void(0)"><i class="fa fa-floppy-o"></i></a></li>
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane active" id="home">
                <h1 class="sidebar-header">
                    Routes and Layers
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <div id="routes" rv-routes="data">
                    <i id="addNewRoute" class="fa fa-plus-circle fa-2x" style="color:#180d56" rv-on-click="controller.addNewRoute"></i>
                    <ul>
                        <li rv-each-route="data.routes">
                            <span class="header" rv-on-click="controller.headerClick">{ route.name } <i class="fa fa-pencil" rv-class-editactive="route.isEditingRoute" rv-on-click="controller.edit"></i></span>
                            <div rv-show="route.enabled">
                                <div rv-show="route.isEditingRoute">
                                    <label>Route Name:</label><input rv-value="route.name" /><br />
                                </div>
                                <ul rv-each-segment="route.segments">
                                    <li>
                                        <span rv-hide="route.isEditingRoute">{ segment.name }</span>
                                        <label rv-show="route.isEditingRoute">Segment { index }:</label> <input rv-show="route.isEditingRoute"
                                            rv-value="segment.name" />
                                        <ul rv-each-path="segment.paths">
                                            <li>
                                                <span rv-hide="route.isEditingRoute">{ path.name }</span>
                                                <label rv-show="route.isEditingRoute">Step { index }:</label> <input rv-show="route.isEditingRoute"
                                                    rv-value="path.name" />
                                            </li>
                                        </ul>
                                    </li>
                                </ul>

                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="sidebar-pane" id="layers">
                <h1 class="sidebar-header">Layers<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
            <div class="sidebar-pane" id="help">
                <h1 class="sidebar-header">Help<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <h2>Key Bindings</h2>
                <ul>

                </ul>
            </div>
            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
        </div>
    </div>


    <div id="map"></div>
    <!--<input id="slider" type="range" min="0" max="1" step="0.1" value="1" oninput="layer.setOpacity(this.value)">-->

    <div id="legend" rv-show="showLegend" class="info legend">
        <div rv-show="isEditingRoute">
            Controls<br />
            <hr />
            End Current Step: <strong>{ fromCharCode | call config.Controls.SavePathPart }</strong><br />
            Undo Last Line: <strong>{ fromCharCode | call config.Controls.RemoveLastPathPart }</strong><br />
            Cancel Step: <strong>{ fromCharCode | call config.Controls.CancelPath }</strong><br />
            New Segment: <strong>{ fromCharCode | call config.Controls.NewSegment }</strong><br />
            Toggle Map Dragging: <strong>{ fromCharCode | call config.Controls.DraggingToggle }</strong><br />
        </div>
    </div>

</body>
<!--
                Controls: { //Currently using "keypress" vs "keydown" due to lack of "keydown" support in leaflet
                    CancelPath: 120, //x
                    RemoveLastPathPart: 99, //c
                    SavePathPart: 13, //enter
                    NewSegment: 115, //s
                    DraggingToggle: 100 //d
-->

</html>